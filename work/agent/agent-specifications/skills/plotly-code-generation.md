# Plotly Code Generation Skill

## Overview

Generate complete, executable Python code for Streamlit visualizations using Plotly Express.

## Code Generation Requirements

### Function Signature (MANDATORY)
```python
def render_visualization(viz_type: str, columns: list, rows: list):
    """Render visualization based on data - GENERATED BY AGENT"""
    # Your code here
```

### Required Imports (Use exactly as shown)
```python
import pandas as pd
import streamlit as st
import plotly.express as px
```

### Code Structure
1. Convert rows to DataFrame: `df = pd.DataFrame(rows, columns=columns)`
2. Generate Plotly figure OR display table
3. Render with: `st.plotly_chart(fig, use_container_width=True)`
4. Add context: `st.caption(...)` for row counts or insights

## Code Patterns by Chart Type

### 1. TABLE VIEW

**Code Pattern:**
```python
def render_visualization(viz_type: str, columns: list, rows: list):
    import pandas as pd
    import streamlit as st

    df = pd.DataFrame(rows, columns=columns)
    st.dataframe(df, use_container_width=True, hide_index=True)
    st.caption(f"Showing {len(df)} rows Ã— {len(df.columns)} columns")
```

### 2. BAR CHART

**Code Pattern:**
```python
def render_visualization(viz_type: str, columns: list, rows: list):
    import pandas as pd
    import streamlit as st
    import plotly.express as px

    df = pd.DataFrame(rows, columns=columns)

    fig = px.bar(
        df,
        x="category_column",  # Use actual column name from data
        y="metric_column",    # Use actual column name from data
        title="[Descriptive Title Based on User Question]",
        labels={"category_column": "Friendly Label", "metric_column": "Friendly Label"},
        color="category_column",  # Optional: color by category
        text="metric_column"      # Optional: show values on bars
    )
    fig.update_traces(texttemplate='%{text:.2s}', textposition='outside')
    fig.update_layout(showlegend=False, xaxis_tickangle=-45)

    st.plotly_chart(fig, use_container_width=True)
    st.caption(f"Comparing {len(df)} categories")
```

### 3. LINE CHART (Time Series)

**Code Pattern:**
```python
def render_visualization(viz_type: str, columns: list, rows: list):
    import pandas as pd
    import streamlit as st
    import plotly.express as px

    df = pd.DataFrame(rows, columns=columns)

    # Ensure date column is datetime type
    df['date_column'] = pd.to_datetime(df['date_column'])
    df = df.sort_values('date_column')  # Ensure chronological order

    fig = px.line(
        df,
        x="date_column",
        y="metric_column",
        title="[Metric] Over Time",
        markers=True,  # Add markers for data points
        labels={"date_column": "Time Period", "metric_column": "Friendly Label"}
    )
    fig.update_xaxis(tickformat="%b %Y")  # Format dates nicely

    st.plotly_chart(fig, use_container_width=True)
    st.caption(f"Time series data: {len(df)} periods")
```

### 4. PIE CHART (Distribution)

**Code Pattern:**
```python
def render_visualization(viz_type: str, columns: list, rows: list):
    import pandas as pd
    import streamlit as st
    import plotly.express as px

    df = pd.DataFrame(rows, columns=columns)

    fig = px.pie(
        df,
        names="category_column",
        values="value_column",
        title="Distribution of [Metric] by [Category]",
        hole=0.3  # Donut chart (optional, remove for full pie)
    )
    fig.update_traces(textposition='inside', textinfo='percent+label')

    st.plotly_chart(fig, use_container_width=True)
    st.caption(f"Distribution across {len(df)} categories")
```

### 5. SCATTER PLOT

**Code Pattern:**
```python
def render_visualization(viz_type: str, columns: list, rows: list):
    import pandas as pd
    import streamlit as st
    import plotly.express as px

    df = pd.DataFrame(rows, columns=columns)

    fig = px.scatter(
        df,
        x="numeric_column_1",
        y="numeric_column_2",
        title="Correlation: [X Metric] vs [Y Metric]",
        labels={"numeric_column_1": "Friendly Label", "numeric_column_2": "Friendly Label"},
        trendline="ols",  # Optional: add regression line
        color="category_column"  # Optional: color by category
    )

    st.plotly_chart(fig, use_container_width=True)
    st.caption(f"Analyzing {len(df)} data points")
```

## Title & Label Best Practices

### Titles Should:
- Reference the original user question
- Be specific and descriptive
- Start with action verbs: "Production Volume by...", "Distribution of...", "Trend in..."
- Avoid generic titles like "Chart", "Data", "Results"

### Axis Labels Should:
- Use business-friendly terms (not raw column names)
- Include units when applicable (doses, units, batches, %)
- Be concise but clear

### Examples:
- Good: "Batch Production by Business Unit"
- Bad: "bu_source vs batch_count"
- Good: "Production Doses (Millions)"
- Bad: "quantity_doses"

## Error Handling Patterns

### Handle Empty Data
```python
def render_visualization(viz_type: str, columns: list, rows: list):
    import pandas as pd
    import streamlit as st

    if not rows or not columns:
        st.warning("No data available to visualize")
        return

    df = pd.DataFrame(rows, columns=columns)
    # ... rest of code
```

### Handle Missing Values
```python
# Remove or fill nulls before plotting
df = df.dropna(subset=['critical_column'])
# OR
df['column'] = df['column'].fillna(0)
```

### Handle Data Type Issues
```python
# Ensure numeric columns are numeric
df['metric'] = pd.to_numeric(df['metric'], errors='coerce')

# Ensure date columns are datetime
df['date'] = pd.to_datetime(df['date'], errors='coerce')
```

## Complete Working Example

**Question:** "How many batches were produced by each business unit?"

**Data Context:**
- Columns: ['bu_source', 'batch_count']
- Rows: [('poultry', 156), ('ruminants', 89), ('companion', 23)]
- Row count: 3
- Column types: string, integer

**Generated Code:**
```python
def render_visualization(viz_type: str, columns: list, rows: list):
    """Render visualization based on data - GENERATED BY AGENT"""
    import pandas as pd
    import streamlit as st
    import plotly.express as px

    df = pd.DataFrame(rows, columns=columns)

    # Bar chart for categorical comparison
    fig = px.bar(
        df,
        x="bu_source",
        y="batch_count",
        title="Batch Production by Business Unit",
        labels={
            "bu_source": "Business Unit",
            "batch_count": "Number of Batches"
        },
        color="bu_source",
        text="batch_count"
    )

    fig.update_traces(texttemplate='%{text}', textposition='outside')
    fig.update_layout(showlegend=False, xaxis_tickangle=0)

    st.plotly_chart(fig, use_container_width=True)
    st.caption(f"Total batches across {len(df)} business units: {df['batch_count'].sum():,}")
```

## Safety & Quality Checklist

Before returning code, verify:
- [ ] Function signature matches exactly: `def render_visualization(viz_type: str, columns: list, rows: list):`
- [ ] Only imports pandas, streamlit, plotly.express (no os, subprocess, eval, exec)
- [ ] No file I/O operations (no open, write, Path operations)
- [ ] No network calls (no requests, urllib, socket)
- [ ] Column names are taken from actual data, not hardcoded guesses
- [ ] Title reflects the user's question intent
- [ ] Axis labels are business-friendly
- [ ] Error handling for empty data
- [ ] Code is syntactically valid Python

## Output Format

Return ONLY the complete Python function code, without:
- Explanatory text before or after
- Markdown formatting (though ```python blocks are acceptable)
- Multiple alternatives or suggestions
- Comments explaining your reasoning (inline code comments are fine)

The code will be directly injected into a Streamlit application and must be immediately executable.
